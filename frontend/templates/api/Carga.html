{% extends "api/BaseDashboard.html" %}
{% block title %}Carga Masiva{% endblock %}

{% block content %}
<div class="page-title">
  <div>
    <h1>Carga Masiva</h1>
    <p class="muted">Sube archivos DJ1948 o Factores (.csv / .xlsx)</p>
  </div>
</div>

<div class="form-card">
  <form id="cargaForm" enctype="multipart/form-data">
    <div class="form-row">
      <div class="field">
        <label>Archivo</label>
        <input type="file" name="archivo" accept=".csv,.xlsx" required>
      </div>
      <div style="width:180px">
        <label>Tipo</label>
        <select name="tipo_archivo">
          <option value="DJ1948">DJ1948</option>
          <option value="FACTORES">Factores</option>
          <option value="OTRO">Otro</option>
        </select>
      </div>
      <div style="align-self:flex-end">
        <button class="btn" type="submit">Procesar archivo</button>
      </div>
    </div>
  </form>
</div>

<div style="margin-top:18px">
  <h3>Historial de cargas</h3>
  <table class="table">
    <thead><tr><th>ID</th><th>Archivo</th><th>Usuario</th><th>Fecha</th><th>Estado</th><th>Acción</th></tr></thead>
    <tbody>
      {% for carga in cargas %}
      <tr id="row-{{ carga.id }}">
        <td>{{ carga.id }}</td>
        <td>{{ carga.archivo.name|slice:"-30:" }}</td>
        <td>{{ carga.usuario.username|default:"Desconocido" }}</td>
        <td>{{ carga.fecha_carga|date:"Y-m-d H:i" }}</td>
        <td>{{ carga.estado }}</td>
        <td>
          <a href="{% url 'api:archivo_descargar' carga.id %}" class="btn small">Descargar</a>
          <button class="btn small ghost eliminar-btn" data-id="{{ carga.id }}">Eliminar</button>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="6" style="text-align:center;padding:18px">No hay cargas</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
document.getElementById('cargaForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const fd = new FormData(this);
  const rsp = await fetch("{% url 'api:archivo-carga-procesar' %}", {
    method:'POST', headers:{'X-CSRFToken':'{{ csrf_token }}'}, body: fd
  });
  const data = await rsp.json();
  if (data.success || data.id || data.carga) {
    alert('✅ Archivo subido');
    location.reload();
  } else {
    alert('❌ Error: ' + (data.error||''));
  }
});

document.querySelectorAll('.eliminar-btn').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    if (!confirm('¿Eliminar este archivo?')) return;
    const id = btn.dataset.id;
    const r = await fetch(`/api/archivos/${id}/`, {
      method: 'DELETE', headers: {'X-CSRFToken': '{{ csrf_token }}'}
    });
    if (r.ok) { document.getElementById('row-'+id).remove(); alert('Eliminado'); }
  });
});
</script>
{% endblock %}
