{% extends "api/BaseDashboard.html" %}
{% load static %}

{% block title %}Carga Masiva{% endblock %}

{% block content %}
<div class="dashboard-content">

    <h1>Carga Masiva</h1>
    <p class="text-muted small">Archivos DJ1948 y Factores</p>

    <!-- FORMULARIO DE CARGA -->
    <div class="card" style="max-width: 900px; width: 100%; text-align: left;">
        <form id="cargaForm" enctype="multipart/form-data">
            <div class="form-group" style="margin-bottom: 20px;">
                <label>Archivo a cargar</label>
                <input type="file" name="archivo" accept=".csv,.xlsx" required style="width: 100%; margin-top:5px;">
            </div>
            <div class="form-group" style="margin-bottom: 20px;">
                <label>Tipo de carga</label>
                <select name="tipo_archivo" style="width: 100%; padding: 10px; margin-top:5px;">
                    <option value="DJ1948">DJ1948 - Montos</option>
                    <option value="FACTORES">Factores</option>
                    <option value="OTRO">Otro</option>
                </select>
            </div>
            <button class="btn" type="submit" style="background:#004aad; color:white; padding:10px 18px; border-radius:6px;">
                Procesar archivo
            </button>
        </form>
    </div>

    <!-- HISTORIAL DE CARGAS -->
    <div class="card" style="max-width:900px; width:100%; margin-top:25px;">
        <h3>Historial de Cargas</h3>
        <div style="overflow-x:auto; margin-top:10px;">
            <table class="table">
                <thead>
                    <tr style="background:#003366; color:white;">
                        <th>ID</th>
                        <th>Archivo</th>
                        <th>Usuario</th>
                        <th>Fecha</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="historialCargas">
                    {% for carga in cargas %}
                    <tr>
                        <td>{{ carga.id }}</td>
                        <td>{{ carga.archivo.name|slice:"-30:" }}</td>
                        <td>{{ carga.usuario.username }}</td>
                        <td>{{ carga.fecha_carga|date:"Y-m-d H:i" }}</td>
                        <td>{{ carga.estado }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5">No hay cargas registradas.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.getElementById('cargaForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    const response = await fetch("{% url 'api:archivo-carga-procesar' %}", {
        method: "POST",
        headers: {"X-CSRFToken": "{{ csrf_token }}"},
        body: formData
    });

    const data = await response.json();

    if(data.success) {
        alert("✅ Archivo cargado correctamente!");
        location.reload();  // recarga la página para actualizar historial
    } else {
        alert("❌ Error: " + (data.error || 'No se pudo cargar'));
    }
});
</script>
{% endblock %}



